from pyrogram import filters
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from bot import bot
import sqlite3
import logging

# /start â†’ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø£Ùˆ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
@bot.on_message(filters.command("start"))
async def start_handler(client, message):
    await show_main_menu(client, message, message.from_user.id, message.from_user.first_name)

# Ø²Ø± ğŸ”™ ÙŠØ±Ø¬Ø¹ Ù„Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø£Ùˆ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
@bot.on_callback_query(filters.regex("^back_to_start$"))
async def handle_back_to_start(client, callback_query):
    await show_main_menu(client, callback_query.message, callback_query.from_user.id, callback_query.from_user.first_name)

# Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async def show_main_menu(client, msg_obj, user_id, user_first_name):
    conn = sqlite3.connect("college.db")
    cursor = conn.cursor()
    cursor.execute("""
        SELECT courses.id, courses.name FROM courses
        JOIN user_courses ON user_courses.course_id = courses.id
        WHERE user_courses.user_id = ?
    """, (user_id,))
    courses = cursor.fetchall()
    conn.close()

    if courses:
        text = "ğŸ“‹ Ù‡Ø°Ù‡ Ù‡ÙŠ Ù…Ù‚Ø±Ø±Ø§ØªÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:\n\n"
        buttons = [[InlineKeyboardButton(name, callback_data=f"course_{cid}")] for cid, name in courses]
        await msg_obj.edit_text(
            text + "\nğŸ‘‡ Ø§Ø®ØªØ± Ù…Ù‚Ø±Ø± Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆØ§Ù‡:",
            reply_markup=InlineKeyboardMarkup(buttons)
        )
    else:
        welcome = (
            f"Ø§Ø²ÙŠÙƒ ÙŠØ§ {user_first_name} ğŸ‘‹\n"
            "Ø£Ù†Ø§ Ø¨ÙˆØª ÙƒÙ„ÙŠØ© Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø¬Ø§Ù…Ø¹Ø© Ø¨Ù†Ù‡Ø§ ğŸ“\n"
            "Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠØ© ğŸ‘‡"
        )
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("ğŸ“ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„", callback_data="level_1")],
            [InlineKeyboardButton("ğŸ“ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ", callback_data="level_2")],
            [InlineKeyboardButton("ğŸ“ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù„Ø«", callback_data="level_3")],
            [InlineKeyboardButton("ğŸ“ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¨Ø¹", callback_data="level_4")],
            [InlineKeyboardButton("ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø±Ø±Ø§ØªÙŠ", callback_data="start_registration")]
        ])
        await msg_obj.edit_text(welcome, reply_markup=keyboard)

# Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
@bot.on_callback_query(filters.regex("^level_[1-4]$"))
async def choose_term(client, callback_query):
    level = int(callback_query.data.split("_")[1])
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ“˜ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„", callback_data=f"term_1_level_{level}")],
        [InlineKeyboardButton("ğŸ“— Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ", callback_data=f"term_2_level_{level}")],
        [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")]
    ])
    await callback_query.message.edit_text("Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:", reply_markup=keyboard)

# Ø¹Ø±Ø¶ Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„ØªØ±Ù…
@bot.on_callback_query(filters.regex("^term_[1-2]_level_[1-4]$"))
async def show_courses(client, callback_query):
    data = callback_query.data.split("_")
    term = int(data[1])
    level = int(data[3])

    conn = sqlite3.connect("college.db")
    cursor = conn.cursor()
    cursor.execute("SELECT id, name FROM courses WHERE level = ? AND term = ?", (level, term))
    courses = cursor.fetchall()
    conn.close()

    if not courses:
        await callback_query.message.edit_text("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø±Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.")
        return

    buttons = [[InlineKeyboardButton(f"ğŸ“˜ {name}", callback_data=f"course_{cid}")] for cid, name in courses]
    buttons.append([InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")])
    await callback_query.message.edit_text("ğŸ“š Ø§Ø®ØªØ± Ù…Ù‚Ø±Ø±:", reply_markup=InlineKeyboardMarkup(buttons))

# Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ù…Ù‚Ø±Ø±
@bot.on_callback_query(filters.regex("^course_\\d+$"))
async def course_options(client, callback_query):
    course_id = int(callback_query.data.split("_")[1])
    conn = sqlite3.connect("college.db")
    cursor = conn.cursor()
    cursor.execute("SELECT name, has_sections FROM courses WHERE id = ?", (course_id,))
    course = cursor.fetchone()
    conn.close()

    if not course:
        await callback_query.message.edit_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø±Ø±.")
        return

    course_name, has_sections = course
    buttons = [
        [InlineKeyboardButton("ğŸ“š Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª", callback_data=f"lectures_{course_id}")],
        [InlineKeyboardButton("ğŸ§ª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª", callback_data=f"exams_{course_id}")]
    ]

    if has_sections:
        buttons.append([InlineKeyboardButton("ğŸ“¥ Ø³Ù„Ø§ÙŠØ¯Ø§Øª Ø§Ù„Ø³ÙƒØ§Ø´Ù†", callback_data=f"sections_{course_id}")])

    buttons.append([InlineKeyboardButton("â° Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ù‡Ù…Ø©", callback_data=f"deadlines_{course_id}")])
    buttons.append([InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")])

    await callback_query.message.edit_text(
        f"ğŸ“˜ Ù…Ø­ØªÙˆÙ‰ Ù…Ù‚Ø±Ø±: {course_name}",
        reply_markup=InlineKeyboardMarkup(buttons)
    )

# Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
@bot.on_callback_query(filters.regex("^lectures_\\d+$"))
async def show_lectures(client, callback_query):
    course_id = int(callback_query.data.split("_")[1])
    conn = sqlite3.connect("college.db")
    cursor = conn.cursor()
    cursor.execute("SELECT id, title FROM lectures WHERE course_id = ?", (course_id,))
    lectures = cursor.fetchall()
    conn.close()

    if not lectures:
        await callback_query.message.edit_text("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª.")
        return

    buttons = [
        [InlineKeyboardButton(f"ğŸ“„ {title}", callback_data=f"open_lecture_{lid}")]
        for lid, title in lectures
    ]
    buttons.append([InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")])
    await callback_query.message.edit_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©:", reply_markup=InlineKeyboardMarkup(buttons))
